---
title: "[NeoVim/coc.nvim]clangd/clang-formatでC/C++の快適な開発環境を整える"
emoji: "🍺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["NeoVim","coc","clangd","llvm"]
published: true
---

最近、低レイヤ理解のためにゼロからのOS自作入門をはじめました。

https://www.amazon.co.jp/dp/4839975868

この本を進めるにあたり、C/C++の（快適な）開発環境が必要になるので、clangdとclang-formatを導入してみました。

開発マシンはMac、エディタはNeoVimです。LSPクライアントは[coc.nvim](https://github.com/neoclide/coc.nvim)を使用しています。NeoVimやcoc.nvimの導入方法については触れません。


# clangd

## インストール

clangdはLLVMプロジェクトの一部なので、MacであればHomebrewでllvmをインストールするだけで利用できます。

```shell
$ brew install llvm
$ clangd --version
clangd version 11.0.0
```

## coc-clangdのインストール

coc.nvimがclangdに接続するために、[coc-clangd](https://github.com/clangd/coc-clangd)というプラグインをインストールする必要があります。


```vim
:CocInstall coc-clangd
```

`:CocConfig`で設定を変更することができます。デフォルトのままでも補完やエラーチェックは行ってくれます。
私は保存時のオートフォーマットを有効にしたかったため、`:CocConfig`で`coc-settings.json`を開き、以下の設定を追加しました。

```json:coc-settings.json
  "coc.preferences.formatOnSaveFiletypes": [
    "cpp"
  ],
```


## セットアップ

各種インストールすれば完了、というわけではありません。

clangdがソースコードの内容・依存関係を把握するために`compile_commands.json`または`compile_flags.txt`というファイルを作成する必要があります。

`compile_flags.json`については、`make`または`cmake`を使用してビルドしている場合は簡単に作成することができます。

### make

[compiledb](https://github.com/nickdiego/compiledb)を利用すると`compiledb make`というコマンドで`compile_commands.json`も合わせて出力してくれます。

```shell
$ pip install compiledb
$ compiledb make
```

参考：[Big Sky :: clangd を使う時に便利なコマンド compiledb](https://mattn.kaoriya.net/software/vim/20181225235003.htm)

### cmake

`cmake`実行時に`-DCMAKE_EXPORT_COMPILE_COMMANDS=1`というオプションを付ければ`compile_commands.json`を作成してくれます。

```shell
$ mkdir build
$ cd build
$ cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=1

# 作業ディレクトリのルートにシンボリックリンクをはる
$ ln -s $(pwd)/compile_commands.json $(pwd)/../
```

### それ以外

makeやcmakeを使っていない場合は`compile_flags.txt`を手で作成して作業ディレクトリのルートに配置することで補完や定義へ移動等が有効になります。

```compile_flags.txt
# 例
-I/usr/local/include
```

参考：[Getting started](https://clangd.llvm.org/installation.html)


# clang-format

## インストール

clang-formatもLLVMプロジェクトの一部なので、（Macの場合）llvmをインストールすると一緒にインストールされます。

```shell
$ clang-format --version
clang-format version 11.0.0
```

## セットアップ

`.clang-format`というファイルを作成して作業ディレクトリにルートに配置します。

各設定の意味は下記に記載されています。

[Clang-Format Style Options](https://clang.llvm.org/docs/ClangFormatStyleOptions.html)

膨大なので全部目を通して一から`.clang-format`を作成するのは大変かもしれません。 そのため、以下のコマンドで`-style`に指定したルールを一式を`.clang-format`に出力して利用します。

```shell
$ clang-format -style=llvm --dump-config > .clang-format
```

`-style`には以下の種類があります。私はとりあえず`google`を指定しています。

```
LLVM A style complying with the LLVM coding standards

Google A style complying with Google’s C++ style guide

Chromium A style complying with Chromium’s style guide

Mozilla A style complying with Mozilla’s style guide

WebKit A style complying with WebKit’s style guide

Microsoft A style complying with Microsoft’s style guide

GNU A style complying with the GNU coding standards
```

参考：[Configurable Format Style Options](https://clang.llvm.org/docs/ClangFormatStyleOptions.html#configurable-format-style-options)


## 使ってみる

ここまで準備できたらclangdによる補完や定義へ移動、clang-formatによるコードの自動整形が有効になります。

clangdの導入前は以下のようにインクルードしているヘッダーが見つからず警告が出ています。

![](https://storage.googleapis.com/zenn-user-upload/1k8mcg8mdg3jdmactt0xhm8e0n81)

clangdとclang-formatのセットアップ完了後、以下のように警告は消えてコードも整形されます。

![](https://storage.googleapis.com/zenn-user-upload/6w7xwluklocjdggbx7xc3sal1y0j)

hoverで定義やヒントを確認することができます（coc.nvimの設定が必要です）。

![](https://storage.googleapis.com/zenn-user-upload/9q71ns45vq853w6exxrdt0c4jx90)

