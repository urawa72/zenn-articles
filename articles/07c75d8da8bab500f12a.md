---
title: "[NeoVim/coc.nvim]clangd/clang-formatã§C/C++ã®å¿«é©ãªé–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã‚‹"
emoji: "ğŸº"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["NeoVim","coc","clangd","llvm"]
published: true
---

æœ€è¿‘ã€ä½ãƒ¬ã‚¤ãƒ¤ç†è§£ã®ãŸã‚ã«ã‚¼ãƒ­ã‹ã‚‰ã®OSè‡ªä½œå…¥é–€ã‚’ã¯ã˜ã‚ã¾ã—ãŸã€‚

https://www.amazon.co.jp/dp/4839975868

ã“ã®æœ¬ã‚’é€²ã‚ã‚‹ã«ã‚ãŸã‚Šã€C/C++ã®ï¼ˆå¿«é©ãªï¼‰é–‹ç™ºç’°å¢ƒãŒå¿…è¦ã«ãªã‚‹ã®ã§ã€clangdã¨clang-formatã‚’å°å…¥ã—ã¦ã¿ã¾ã—ãŸã€‚

é–‹ç™ºãƒã‚·ãƒ³ã¯Macã€ã‚¨ãƒ‡ã‚£ã‚¿ã¯NeoVimã§ã™ã€‚LSPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯[coc.nvim](https://github.com/neoclide/coc.nvim)ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚NeoVimã‚„coc.nvimã®å°å…¥æ–¹æ³•ã«ã¤ã„ã¦ã¯è§¦ã‚Œã¾ã›ã‚“ã€‚


# clangd

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

clangdã¯LLVMãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€éƒ¨ãªã®ã§ã€Macã§ã‚ã‚Œã°Homebrewã§llvmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã ã‘ã§åˆ©ç”¨ã§ãã¾ã™ã€‚

```shell
$ brew install llvm
$ clangd --version
clangd version 11.0.0
```

## coc-clangdã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

coc.nvimãŒclangdã«æ¥ç¶šã™ã‚‹ãŸã‚ã«ã€[coc-clangd](https://github.com/clangd/coc-clangd)ã¨ã„ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


```vim
:CocInstall coc-clangd
```

`:CocConfig`ã§è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§ã‚‚è£œå®Œã‚„ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã¯è¡Œã£ã¦ãã‚Œã¾ã™ã€‚
ç§ã¯ä¿å­˜æ™‚ã®ã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æœ‰åŠ¹ã«ã—ãŸã‹ã£ãŸãŸã‚ã€`:CocConfig`ã§`coc-settings.json`ã‚’é–‹ãã€ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

```json:coc-settings.json
  "coc.preferences.formatOnSaveFiletypes": [
    "cpp"
  ],
```


## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

å„ç¨®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°å®Œäº†ã€ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

clangdãŒã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å†…å®¹ãƒ»ä¾å­˜é–¢ä¿‚ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã«`compile_commands.json`ã¾ãŸã¯`compile_flags.txt`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`compile_flags.json`ã«ã¤ã„ã¦ã¯ã€`make`ã¾ãŸã¯`cmake`ã‚’ä½¿ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã‚‹å ´åˆã¯ç°¡å˜ã«ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### make

[compiledb](https://github.com/nickdiego/compiledb)ã‚’åˆ©ç”¨ã™ã‚‹ã¨`compiledb make`ã¨ã„ã†ã‚³ãƒãƒ³ãƒ‰ã§`compile_commands.json`ã‚‚åˆã‚ã›ã¦å‡ºåŠ›ã—ã¦ãã‚Œã¾ã™ã€‚

```shell
$ pip install compiledb
$ compiledb make
```

å‚è€ƒï¼š[Big Sky :: clangd ã‚’ä½¿ã†æ™‚ã«ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰ compiledb](https://mattn.kaoriya.net/software/vim/20181225235003.htm)

### cmake

`cmake`å®Ÿè¡Œæ™‚ã«`-DCMAKE_EXPORT_COMPILE_COMMANDS=1`ã¨ã„ã†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚Œã°`compile_commands.json`ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚

```shell
$ mkdir build
$ cd build
$ cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=1

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ã¯ã‚‹
$ ln -s $(pwd)/compile_commands.json $(pwd)/../
```

### ãã‚Œä»¥å¤–

makeã‚„cmakeã‚’ä½¿ã£ã¦ã„ãªã„å ´åˆã¯`compile_flags.txt`ã‚’æ‰‹ã§ä½œæˆã—ã¦ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã«é…ç½®ã™ã‚‹ã“ã¨ã§è£œå®Œã‚„å®šç¾©ã¸ç§»å‹•ç­‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

```compile_flags.txt
# ä¾‹
-I/usr/local/include
```

å‚è€ƒï¼š[Getting started](https://clangd.llvm.org/installation.html)


# clang-format

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

clang-formatã‚‚LLVMãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€éƒ¨ãªã®ã§ã€ï¼ˆMacã®å ´åˆï¼‰llvmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

```shell
$ clang-format --version
clang-format version 11.0.0
```

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

`.clang-format`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ«ãƒ¼ãƒˆã«é…ç½®ã—ã¾ã™ã€‚

å„è¨­å®šã®æ„å‘³ã¯ä¸‹è¨˜ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

[Clang-Format Style Options](https://clang.llvm.org/docs/ClangFormatStyleOptions.html)

è†¨å¤§ãªã®ã§å…¨éƒ¨ç›®ã‚’é€šã—ã¦ä¸€ã‹ã‚‰`.clang-format`ã‚’ä½œæˆã™ã‚‹ã®ã¯å¤§å¤‰ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ ãã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§`-style`ã«æŒ‡å®šã—ãŸãƒ«ãƒ¼ãƒ«ã‚’ä¸€å¼ã‚’`.clang-format`ã«å‡ºåŠ›ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚

```shell
$ clang-format -style=llvm --dump-config > .clang-format
```

`-style`ã«ã¯ä»¥ä¸‹ã®ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚ç§ã¯ã¨ã‚Šã‚ãˆãš`google`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```
LLVM A style complying with the LLVM coding standards

Google A style complying with Googleâ€™s C++ style guide

Chromium A style complying with Chromiumâ€™s style guide

Mozilla A style complying with Mozillaâ€™s style guide

WebKit A style complying with WebKitâ€™s style guide

Microsoft A style complying with Microsoftâ€™s style guide

GNU A style complying with the GNU coding standards
```

å‚è€ƒï¼š[Configurable Format Style Options](https://clang.llvm.org/docs/ClangFormatStyleOptions.html#configurable-format-style-options)


## ä½¿ã£ã¦ã¿ã‚‹

ã“ã“ã¾ã§æº–å‚™ã§ããŸã‚‰clangdã«ã‚ˆã‚‹è£œå®Œã‚„å®šç¾©ã¸ç§»å‹•ã€clang-formatã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ã®è‡ªå‹•æ•´å½¢ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

clangdã®å°å…¥å‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãšè­¦å‘ŠãŒå‡ºã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/1k8mcg8mdg3jdmactt0xhm8e0n81)

clangdã¨clang-formatã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ã«è­¦å‘Šã¯æ¶ˆãˆã¦ã‚³ãƒ¼ãƒ‰ã‚‚æ•´å½¢ã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/6w7xwluklocjdggbx7xc3sal1y0j)

hoverã§å®šç¾©ã‚„ãƒ’ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆcoc.nvimã®è¨­å®šãŒå¿…è¦ã§ã™ï¼‰ã€‚

![](https://storage.googleapis.com/zenn-user-upload/9q71ns45vq853w6exxrdt0c4jx90)

